---
# Copy base Suricata configuration, then customize with lineinfile for idempotency

- name: Copy Suricata base configuration file
  ansible.builtin.copy:
    src: suricata.yaml
    dest: /etc/suricata/suricata.yaml
    owner: root
    group: root
    mode: 0640
    backup: true
    force: false  # Only copy if file doesn't exist - let replace handle updates
  notify: Restart Suricata
  tags: update

- name: Configure HOME_NET in suricata.yaml
  ansible.builtin.lineinfile:
    path: /etc/suricata/suricata.yaml
    regexp: '^\s*HOME_NET:.*$'
    line: '    HOME_NET: "{{ suricata_home_net }}"'
    backup: false
  notify: Restart Suricata
  tags: update

- name: Configure interface in suricata.yaml
  ansible.builtin.replace:
    path: /etc/suricata/suricata.yaml
    regexp: '(^\s*- interface:) \S+'
    replace: '\1 {{ suricata_interface }}'
  notify: Restart Suricata
  tags: update

- name: Copy Suricata Systemd file
  ansible.builtin.copy:
    src: suricata.service
    dest: /etc/systemd/system/suricata.service
    backup: false
    owner: root
    group: root
    mode: 0640
  notify: Restart Suricata

- name: Create necessary directories
  ansible.builtin.file:
    path: /var/lib/suricata/rules
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Create /etc/suricata/rules directory for local rules
  ansible.builtin.file:
    path: /etc/suricata/rules
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Copy Custom Rules file (external source) to suricata-update local path
  ansible.builtin.copy:
    src: "{{ suricata_custom_rules_src }}"
    dest: /etc/suricata/rules/local.rules
    owner: root
    group: root
    mode: 0644
  when: suricata_custom_rules_src != ""
  notify: Restart Suricata
  tags: update

- name: Copy Custom Rules file (default) to suricata-update local path
  ansible.builtin.copy:
    src: ls-custom.rules
    dest: /etc/suricata/rules/local.rules
    owner: root
    group: root
    mode: 0644
  when: suricata_custom_rules_src == ""
  notify: Restart Suricata
  tags: update

- name: Copy custom disabled rules list
  ansible.builtin.copy:
    src: disable.conf
    dest: /etc/suricata/disable.conf
    owner: root
    group: root
    mode: 0644
  notify: Restart Suricata
  tags: update

- name: Update Suricata Rules (includes local.rules automatically)
  ansible.builtin.command:
    cmd: suricata-update --local /etc/suricata/rules/local.rules
  changed_when: false
  ignore_errors: true
  tags: update

- name: Ensure suricata service is enabled and started
  ansible.builtin.service:
    name: suricata.service
    enabled: true
    state: started
  tags: update

- name: Ensure a cron job to run suricata-update is created
  ansible.builtin.cron:
    name: "suricata-update"
    minute: "0"
    hour: "2"
    job: "/usr/bin/suricata-update --no-merge"
